<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Gerenciador de Estacionamento 3D</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; }
    #renderCanvas { width: 100%; height: 100%; display:block; }
    #adminPanel {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.6); color: white;
      padding: 10px; border-radius: 8px; font-family: Arial; line-height: 1.4;
    }
    #loginPanel {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.6); color: white;
      padding: 10px; border-radius: 8px; font-family: Arial;
    }
    #vagaPanel {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 10px; border-radius: 8px; font-family: Arial;
      display: none;
    }
    #vagaPanel button { margin: 3px; padding: 6px 10px; }
    .hint { font-size: 12px; opacity: 0.85; }
  </style>
</head>
<body>
<canvas id="renderCanvas"></canvas>

<div id="adminPanel">
  <div>Vagas livres: <span id="livres">0</span> | Ocupadas: <span id="ocupadas">0</span></div>
</div>

<div id="loginPanel">
  Perfil:
  <select id="roleSelect">
    <option value="viewer">Usuário</option>
    <option value="operator">Operador</option>
    <option value="admin">Administrador</option>
  </select><br/>
  Senha: <input type="password" id="userPass"/>
  <button onclick="login()">Entrar</button>
</div>

<div id="vagaPanel">
  <h4>Gerenciar Vaga</h4>
  <button onclick="ocuparVaga()">Ocupar</button>
  <button onclick="liberarVaga()">Desocupar</button>
  <button onclick="rotacionarVaga(-10)">⟲ Rotacionar</button>
  <button onclick="rotacionarVaga(10)">Rotacionar ⟳</button>
  <button onclick="ativarMover()">Mover</button>
  <button onclick="deletarVaga()">Deletar</button>
</div>

<script>
  // --- Config Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyAE8AgqS_rpQygvmO6ugTX5yQSjQDwJ0vk",
    authDomain: "smamus3d.firebaseapp.com",
    databaseURL: "https://smamus3d-default-rtdb.firebaseio.com",
    projectId: "smamus3d",
    storageBucket: "smamus3d.firebasestorage.app",
    messagingSenderId: "951385126549",
    appId: "1:951385126549:web:c80ed059acdf45bdcc8d9c",
    measurementId: "G-H52V7SLBGE"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- Variáveis globais ---
  const canvas = document.getElementById("renderCanvas");
  const engine = new BABYLON.Engine(canvas, true);
  let scene, camera;
  let vagas = [];
  let vagaSelecionada = null;
  let moverAtivo = false;
  let role = "viewer";
  const PASSWORDS = { operator: "op123", admin: "admin123" };
  const PARKING_MODEL_FILE = "modelo.glb"; 
  const CAR_BASE_URL = "https://linckrafael.github.io/cars3D/";
  const CAR_MODELS = ["car1.glb","car2.glb","car3.glb","car5.glb","car6.glb","car7.glb","car8.glb","car9.glb","car10.glb","car12.glb","car13.glb","car14.glb","car15.glb","car19.glb"];
  const VAGA_LARGURA = 4.0;
  const VAGA_COMPRIMENTO = 8.0;
  const VAGA_ALTURA = 2.0;
  const MARGEM_ESCALA = 0.95;

  // --- Funções login ---
  function login(){
    const selected = document.getElementById("roleSelect").value;
    const pass = document.getElementById("userPass").value;
    if(selected === "viewer"){ role = "viewer"; alert("Modo Visualizador"); }
    else if(pass === PASSWORDS[selected]){ role = selected; alert("Modo " + (role === "admin" ? "Administrador" : "Operador") + " Ativado"); }
    else{ alert("Senha incorreta"); return; }
    atualizarInterface();
  }
  function atualizarInterface(){
    document.querySelectorAll("#vagaPanel button").forEach(btn => btn.style.display = "none");
    if(role === "operator"){
      document.querySelector("button[onclick='ocuparVaga()']").style.display = "inline-block";
      document.querySelector("button[onclick='liberarVaga()']").style.display = "inline-block";
    }
    if(role === "admin"){
      document.querySelectorAll("#vagaPanel button").forEach(btn => btn.style.display = "inline-block");
    }
  }

  function atualizarPainel(){
    const livres = vagas.filter(v => !v.ocupada).length;
    const ocupadas = vagas.length - livres;
    document.getElementById("livres").innerText = livres;
    document.getElementById("ocupadas").innerText = ocupadas;
  }

  // --- BABYLON ---
  scene = new BABYLON.Scene(engine);
  camera = new BABYLON.UniversalCamera("camera", new BABYLON.Vector3(0, 12, -28), scene);
  camera.attachControl(canvas, true);
  camera.keysUp.push(87); camera.keysDown.push(83); camera.keysLeft.push(65); camera.keysRight.push(68);
  camera.speed = 15; camera.angularSensibility = 450; camera.inertia = 0.1;
  camera.inputs.addMouseWheel(); camera.wheelPrecision = 50; camera.rotation.y = Math.PI;

  new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);
  const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 1000, height: 1000}, scene);
  ground.position.y = -0.05;
  const groundMat = new BABYLON.StandardMaterial("groundMat", scene);
  groundMat.diffuseColor = new BABYLON.Color3(0.4,0.4,0.4);
  ground.material = groundMat;

  const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size:1000}, scene);
  const skyboxMat = new BABYLON.StandardMaterial("skyBoxMat", scene);
  skyboxMat.backFaceCulling = false; skyboxMat.diffuseColor = new BABYLON.Color3(0,0,0);
  skyboxMat.specularColor = new BABYLON.Color3(0,0,0);
  skyboxMat.reflectionTexture = new BABYLON.CubeTexture("https://playground.babylonjs.com/textures/skybox", scene);
  skyboxMat.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
  skybox.material = skyboxMat;

  BABYLON.SceneLoader.Append("https://linckrafael.github.io/Smamus3Dv7/", PARKING_MODEL_FILE, scene);

  // --- Utilitários ---
  function getSizeOf(node){ const bv = node.getHierarchyBoundingVectors(true); return { size: bv.max.subtract(bv.min), bv }; }
  function criarVagaContorno(pos){ 
      const plane = BABYLON.MeshBuilder.CreatePlane("vagaPlane",{width:VAGA_LARGURA,height:VAGA_COMPRIMENTO},scene); 
      plane.rotation.x=Math.PI/2; plane.position=pos.clone().add(new BABYLON.Vector3(0,0.01,0)); 
      const mat=new BABYLON.StandardMaterial("vagaMat",scene); 
      mat.diffuseColor=new BABYLON.Color3(0,1,0); mat.alpha=0.3; plane.material=mat; plane.isPickable=true; 
      return plane; 
  }
  function selecionarVaga(vaga){ vagaSelecionada=vaga; document.getElementById("vagaPanel").style.display="block"; atualizarInterface(); }
  function encontrarVagaPorMesh(mesh){ return vagas.find(v=>v.mesh===mesh); }
  function normalizarOrientacao(carroRoot){ 
      let {size}=getSizeOf(carroRoot); 
      const minAxis=(size.x<=size.y && size.x<=size.z)?'x':(size.y<=size.x && size.y<=size.z?'y':'z'); 
      if(minAxis==='z'){ carroRoot.rotate(BABYLON.Axis.X,-Math.PI/2); } 
      else if(minAxis==='x'){ carroRoot.rotate(BABYLON.Axis.Z,Math.PI/2); } 
      ({size}=getSizeOf(carroRoot)); 
      if(size.x>size.z){ carroRoot.rotate(BABYLON.Axis.Y,-Math.PI/2); } 
  }
  function posicionarSobreVaga(carroRoot,vagaMesh){ 
      const {bv}=getSizeOf(carroRoot); 
      const minY=bv.min.y; 
      carroRoot.position.x=vagaMesh.position.x; 
      carroRoot.position.z=vagaMesh.position.z; 
      carroRoot.position.y=vagaMesh.position.y-minY+0.01; 
  }
  function escalarParaVaga(carroRoot){ 
      const oldRotY=carroRoot.rotation.y; carroRoot.rotation.y=0; 
      const {size}=getSizeOf(carroRoot); 
      const sx=VAGA_LARGURA/size.x; const sy=VAGA_ALTURA/size.y; const sz=VAGA_COMPRIMENTO/size.z; 
      const s=Math.min(sx,sy,sz)*MARGEM_ESCALA; carroRoot.scaling.set(s,s,s); carroRoot.rotation.y=oldRotY; 
  }

  async function carregarCarroNormalizado(modelIndex, vaga){ 
      const file=CAR_MODELS[modelIndex]; 
      const container=await BABYLON.SceneLoader.LoadAssetContainerAsync(CAR_BASE_URL,file,scene); 
      const carroRoot=new BABYLON.TransformNode("carroRoot",scene); 
      container.meshes.forEach(m=>{if(m.parent==null)m.parent=carroRoot;}); 
      container.addAllToScene(); 
      carroRoot.rotationQuaternion=null; normalizarOrientacao(carroRoot); escalarParaVaga(carroRoot); 
      carroRoot.rotation.y=vaga.mesh.rotation.y; posicionarSobreVaga(carroRoot,vaga.mesh); 
      return carroRoot; 
  }

  // --- Firebase sincronização ---
  function atualizarFirebase(vaga){
      db.ref('vagas/'+vaga.id).set({
          x: vaga.mesh.position.x,
          z: vaga.mesh.position.z,
          rotY: vaga.mesh.rotation.y,
          ocupada: vaga.ocupada,
          carIndex: vaga.carIndex!==undefined?vaga.carIndex:null
      });
      // Atualiza cor do contorno
      if(vaga.mesh.material) vaga.mesh.material.diffuseColor = vaga.ocupada?new BABYLON.Color3(1,0,0):new BABYLON.Color3(0,1,0);
  }

  async function ocuparVagaFirebase(vaga, carIndex){
      if(vaga.carro) return;
      vaga.carIndex = carIndex!==undefined?carIndex:vaga.carIndex!==undefined?vaga.carIndex:Math.floor(Math.random()*CAR_MODELS.length);
      const carro = await carregarCarroNormalizado(vaga.carIndex, vaga);
      vaga.carro = carro;
      vaga.ocupada = true;
      atualizarFirebase(vaga);
  }

  // --- Manipulação vagas ---
  async function ocuparVaga(){
      if(role==="viewer"||!vagaSelecionada||vagaSelecionada.ocupada)return;
      const carIndex = Math.floor(Math.random()*CAR_MODELS.length);
      await ocuparVagaFirebase(vagaSelecionada, carIndex);
      atualizarPainel();
  }

  function liberarVaga(){
      if(role==="viewer"||!vagaSelecionada)return;
      if(vagaSelecionada.carro){vagaSelecionada.carro.dispose(); vagaSelecionada.carro=null;}
      vagaSelecionada.ocupada=false; vagaSelecionada.carIndex=null;
      atualizarFirebase(vagaSelecionada);
      atualizarPainel();
  }

  function rotacionarVaga(angulo){
      if(role!=="admin"||!vagaSelecionada)return;
      const rad=BABYLON.Tools.ToRadians(angulo);
      vagaSelecionada.mesh.rotation.y+=rad;
      if(vagaSelecionada.carro){vagaSelecionada.carro.rotation.y+=rad; posicionarSobreVaga(vagaSelecionada.carro,vagaSelecionada.mesh);}
      atualizarFirebase(vagaSelecionada);
  }

  function ativarMover(){ if(role==="admin"&&vagaSelecionada)moverAtivo=true; }

  function deletarVaga(){
      if(role!=="admin"||!vagaSelecionada)return;
      if(vagaSelecionada.carro){vagaSelecionada.carro.dispose(); vagaSelecionada.carro=null;}
      vagaSelecionada.mesh.dispose();
      db.ref('vagas/'+vagaSelecionada.id).remove();
      vagas=vagas.filter(v=>v!==vagaSelecionada);
      vagaSelecionada=null;
      document.getElementById("vagaPanel").style.display="none";
      atualizarPainel();
  }

  // --- Listener Firebase ---
  db.ref('vagas').on('value', snapshot => {
      const data = snapshot.val();
      if(!data) return;
      Object.keys(data).forEach(id=>{
          const vData = data[id];
          let vaga = vagas.find(v=>v.id===id);
          if(!vaga){
              const novaMesh = criarVagaContorno(new BABYLON.Vector3(vData.x,0.01,vData.z));
              novaMesh.rotation.y = vData.rotY;
              vaga = { mesh: novaMesh, ocupada: vData.ocupada, carro: null, id, carIndex: vData.carIndex };
              vagas.push(vaga);
              if(vaga.ocupada) ocuparVagaFirebase(vaga, vaga.carIndex);
          } else {
              vaga.mesh.position.x = vData.x; vaga.mesh.position.z = vData.z; vaga.mesh.rotation.y = vData.rotY;
              vaga.ocupada = vData.ocupada; vaga.carIndex = vData.carIndex;
              if(vaga.carro) vaga.carro.dispose(), vaga.carro=null;
              if(vaga.ocupada) ocuparVagaFirebase(vaga, vaga.carIndex);
              // Atualiza cor
              if(vaga.mesh.material) vaga.mesh.material.diffuseColor = vaga.ocupada?new BABYLON.Color3(1,0,0):new BABYLON.Color3(0,1,0);
          }
      });
      atualizarPainel();
  });

  // --- Interação mouse ---
  scene.onPointerObservable.add(async(pointerInfo)=>{
      if(pointerInfo.type!==BABYLON.PointerEventTypes.POINTERPICK)return;
      const pick=pointerInfo.pickInfo; if(!pick.hit)return;

      if(moverAtivo&&vagaSelecionada){
          vagaSelecionada.mesh.position=pick.pickedPoint.clone().add(new BABYLON.Vector3(0,0.01,0));
          if(vagaSelecionada.carro) posicionarSobreVaga(vagaSelecionada.carro,vagaSelecionada.mesh);
          moverAtivo=false; atualizarFirebase(vagaSelecionada);
          return;
      }

      const isShift=pointerInfo.event&&pointerInfo.event.shiftKey;
      const vaga=encontrarVagaPorMesh(pick.pickedMesh);
      if(vaga&&role!=="viewer"){selecionarVaga(vaga); return;}

      if(role==="admin"&&isShift){
          const id = "vaga_" + Date.now();
          const novaMesh=criarVagaContorno(pick.pickedPoint);
          const vagaObj={mesh:novaMesh,ocupada:false,carro:null,id,carIndex:null};
          vagas.push(vagaObj);
          selecionarVaga(vagaObj);
          atualizarFirebase(vagaObj);
          atualizarPainel();
      }
  });

  window.addEventListener("keydown",(ev)=>{if(ev.key==="Delete"||ev.key==="Del"){deletarVaga();}});
  engine.runRenderLoop(()=>scene.render());
  window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
